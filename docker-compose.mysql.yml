# Docker Compose for Bambuddy with MySQL/MariaDB
#
# Usage:
#   docker compose -f docker-compose.mysql.yml up -d          → pull pre-built images
#   docker compose -f docker-compose.mysql.yml up -d --build  → build bambuddy from source
#
# Data is persisted in named volumes. To start fresh:
#   docker compose -f docker-compose.mysql.yml down -v

services:
  bambuddy:
    image: ghcr.io/maziggy/bambuddy:latest
    build: .
    container_name: bambuddy
    user: "${PUID:-1000}:${PGID:-1000}"
    cap_add:
      - NET_BIND_SERVICE
    network_mode: host
    #
    # macOS/WINDOWS: Docker Desktop doesn't support host mode.
    # Comment out "network_mode: host" above and uncomment "ports:" below.
    #ports:
    #  - "${PORT:-8000}:8000"
    #  - "3000:3000"
    #  - "8883:8883"
    #  - "9990:9990"
    #  - "50000-50100:50000-50100"
    volumes:
      - bambuddy_data:/app/data
      - bambuddy_logs:/app/logs
      - ./virtual_printer:/app/data/virtual_printer
    environment:
      - TZ=${TZ:-Europe/Berlin}
      - PORT=${PORT:-8000}
      # Database configuration
      - DB_TYPE=mysql
      - DB_HOST=${DB_HOST:-127.0.0.1}
      - DB_PORT=${DB_PORT:-3306}
      - DB_NAME=${DB_NAME:-bambuddy}
      - DB_USER=${DB_USER:-bambuddy}
      - DB_PASSWORD=${DB_PASSWORD:-bambuddy}
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped

  mysql:
    image: mariadb:11
    container_name: bambuddy-mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-rootpassword}
      - MYSQL_DATABASE=${DB_NAME:-bambuddy}
      - MYSQL_USER=${DB_USER:-bambuddy}
      - MYSQL_PASSWORD=${DB_PASSWORD:-bambuddy}
    volumes:
      - mysql_data:/var/lib/mysql
    # When bambuddy uses network_mode: host, MySQL must bind to localhost
    # so bambuddy can reach it at 127.0.0.1:3306
    network_mode: host
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

volumes:
  bambuddy_data:
  bambuddy_logs:
  mysql_data:
